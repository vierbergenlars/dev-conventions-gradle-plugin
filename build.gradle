import java.util.stream.Collectors

plugins {
    id 'groovy'
    id 'java-gradle-plugin'
    id 'jacoco'
    id 'maven-publish'
    id 'org.ajoberstar.reckon' version '0.13.0'
    id 'org.sonarqube' version '3.2.0'
    id "com.gradle.plugin-publish" version "0.15.0"
    id "com.github.harbby.gradle.serviceloader" version "1.1.5"
    id 'nebula.integtest' version '8.0.0'
    id 'be.vbgn.dev-conventions.opinion' version '0.5.0'
    id 'be.vbgn.ci-detect' version '0.5.0'
}

group 'be.vbgn.gradle'

sourceCompatibility = 1.8

compileIntegTestJava {
    sourceCompatibility = 11
    targetCompatibility = 11
}

repositories {
    mavenCentral()
    gradlePluginPortal()
}

configurations {
    integTestAdditionalPlugins
}

dependencies {
    testImplementation 'junit:junit:4.13.2'
    integTestAdditionalPlugins project(":fake-ci-detect")
    integTestImplementation "junit:junit:4.13.1"
    integTestImplementation "commons-io:commons-io:2.10.0"
}

gradlePlugin {
    plugins {
        devConventions {
            id = 'be.vbgn.dev-conventions'
            implementationClass = 'be.vbgn.gradle.devconventions.DevConventionsPlugin'
        }
        devOpinions {
            id = 'be.vbgn.dev-conventions.opinion'
            implementationClass = 'be.vbgn.gradle.devconventions.DevOpinionsPlugin'
        }
    }
    testSourceSets(sourceSets.integTest)
}

integrationTest {
    dependsOn(configurations.integTestAdditionalPlugins)
    doFirst {
        systemProperty("be.vbgn.gradle.devconventions.integration.additionalPluginClasspath", configurations.integTestAdditionalPlugins.files.stream().map({ f -> f.path }).collect(Collectors.joining(":")))
    }
}

pluginBundle {
    vcsUrl = "https://github.com/vierbergenlars/dev-conventions-gradle-plugin"
    website = vcsUrl
    description = "A gradle plugin that automatically applies development conventions and/or opinions based on the plugins that are applied to your project"
    tags = ["convention", "integration"]
    plugins {
        devConventions {
            displayName = "Development conventions"
        }
        devOpinions {
            displayName = "Opinitionated development conventions"
        }
    }
}

serviceLoader {
    serviceInterface "be.vbgn.gradle.devconventions.conventions.Convention"
    serviceInterface "be.vbgn.gradle.devconventions.conventions.Opinion"
}
tasks.named('serviceLoaderBuild').configure {
    inputs.files(sourceSets.main.output.classesDirs)
    inputs.property("serviceInterfaces", serviceLoader.serviceInterfaces)
    outputs.dir(sourceSets.main.output.resourcesDir.toString() + "/META-INF/services")
}
classes.finalizedBy("serviceLoaderBuild")
tasks.withType(Test).configureEach {
    dependsOn("serviceLoaderBuild")
}
